name: Visitor Counter

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'data/counter.json'
  schedule:
    - cron: '0 10 * * *'  # Runs daily at 10am UTC
  workflow_dispatch:       # Allows manual trigger

jobs:
  update_visitor_count:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read counter from data/counter.json
        id: read_counter
        run: |
          COUNTER=$(cat data/counter.json | jq .visitor_count)
          echo "COUNTER=$COUNTER" >> $GITHUB_ENV

      - name: Increment counter
        run: |
          NEW_COUNTER=$((COUNTER + 1))
          echo "{\"visitor_count\": $NEW_COUNTER}" > data/counter.json
          echo "Updated visitor count to $NEW_COUNTER"
          echo "NEW_COUNTER=$NEW_COUNTER" >> $GITHUB_ENV

      - name: Update README with new visitor count
        run: |
          echo "Replacing badge URL with new visitor count: $NEW_COUNTER"
          sed -i "s|!\\[Visitor Badge\\](https://img.shields.io/badge/visitors-[0-9]*-blue)|![Visitor Badge](https://img.shields.io/badge/visitors-${NEW_COUNTER}-blue)|" README.md
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add data/counter.json README.md
          git commit -m "Update visitor count to ${NEW_COUNTER}" || echo "No changes to commit"
          git push

